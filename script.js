const translations = {
  "nav.about": {
    "en": "About",
    "de": "Über"
  },
  "nav.team": {
    "en": "Team",
    "de": "Team"
  },
  "nav.download": {
    "en": "Download",
    "de": "Download"
  },
  "nav.contact": {
    "en": "Contact",
    "de": "Kontakt"
  },
   "nav.demo": {
    "en": "Demo",
    "de": "Demo"
  },
  "about.title": {
    "en": "About Us",
    "de": "Über uns"
  },
  "about.content": {
    "en": "Welcome to the Bias Scanner Project! We're all about using technology to tackle bias in online news. Bias Scanner is here to help you navigate the sometimes tricky world of online news, so you can make more informed choices about what you read.",
    "de": "Willkommen beim Bias Scanner Project! Wir setzen Technologie ein, um Voreingenommenheit in Online-Nachrichten zu bekämpfen. Der Bias Scanner soll Ihnen helfen, sich in der manchmal kniffligen Welt der Online-Nachrichten zurechtzufinden, damit Sie informiertere Entscheidungen darüber treffen können, was Sie lesen."
  },
  "whyscanner.title": {
    "en": "Why BiasScanner?",
    "de": "Warum BiasScanner?"
  },
  "whyscanner.content": {
    "en": "In today's world, many of us get our news from the internet. Unfortunately, the web is also home to a lot of biased reporting, fake news, and other not-so-great stuff. Bias Scanner was created to give you a hand in spotting bias when you're reading news articles online.",
    "de": "In der heutigen Welt beziehen viele von uns ihre Nachrichten aus dem Internet. Leider gibt es im Netz auch viele tendenziöse Berichte, Fake News und andere weniger gute Dinge. Der Bias Scanner wurde entwickelt, um Ihnen beim Erkennen von Voreingenommenheit zu helfen, wenn Sie Online-Nachrichten lesen."
  },
  "whatscanner.title": {
    "en": "What's BiasScanner All About?",
    "de": "Worum geht es bei BiasScanner?"
  },
  "whatscanner.content": {
    "en": "BiasScanner is a handy browser plug-in that uses some fancy machine learning tech to find sentences in news articles that might be biased. It works right in your web browser, highlighting potentially biased sentences as you read. If you want to dive deeper, it can even give you a more detailed analysis of the article. The main point is not necessarily to ultimately decide what is biased and what is not. Rather, we want to raise awareness of the issue and encourage discussions and reflections.",
    "de": "BiasScanner ist ein praktisches Browser-Plug-In, das einige ausgeklügelte Machine-Learning-Technologien verwendet, um Sätze in Nachrichtenartikeln zu finden, die möglicherweise voreingenommen sind. Es funktioniert direkt in Ihrem Webbrowser und markiert potenziell voreingenommene Sätze beim Lesen. Wenn Sie tiefer gehen möchten, kann es Ihnen sogar eine detailliertere Analyse des Artikels geben. Es geht dabei nicht unbedingt darum, in letzter Instanz zu entscheiden was jetzt voreingenommen ist und was nicht. Vielmehr möchten wir das Bewusstsein für das Thema schärfen und zu Diskussionen und Reflexionen anregen."
  },
  "whycool.title": {
    "en": "Why It's Cool:",
    "de": "Warum es cool ist:"
  },
  "whycool.inline": {
    "en": "Inline Highlighting: It helps you spot potential bias as you read.",
    "de": "Inline-Markierung: Es hilft Ihnen, potenzielle Voreingenommenheit beim Lesen zu erkennen."
  },
  "whycool.detailed": {
    "en": "Detailed Analysis: If you're curious, it can provide a more in-depth look at the article.",
    "de": "Detaillierte Analyse: Wenn Sie neugierig sind, kann es Ihnen eine eingehendere Betrachtung des Artikels ermöglichen."
  },
  "whycool.strength": {
    "en": "Bias Strength: It rates how strong the detected bias is, from 0 to 1.",
    "de": "Bias-Stärke: Es bewertet, wie stark die erkannte Voreingenommenheit ist, von 0 bis 1."
  },
  "whycool.multilingual": {
    "en": "Multilingual Magic: BiasScanner not only speaks fluent English and German but also understands a plethora of other languages when it comes to dissecting news articles.",
    "de": "Multilinguale Magie: BiasScanner spricht nicht nur fließend Englisch und Deutsch, sondern versteht auch eine Vielzahl anderer Sprachen, wenn es darum geht, Nachrichtenartikel zu zerlegen."
  },
  "whycool.privacy": {
    "en": "Privacy Matters: We're big on privacy - no storing your personal info, ever. We only keep (anonymized) information about the news stories you read when you explicitly donate them for our research.",
    "de": "Datenschutz ist wichtig: Wir legen großen Wert auf Datenschutz - Ihre persönlichen Informationen werden niemals gespeichert. Wir speichern nur (anonymisierte) Informationen über die von Ihnen gelesenen Artikel, die Sie ausdrücklich für unsere Forschung spenden."
  },
  "join.title": {
    "en": "Join Us in the Fight Against Bias",
    "de": "Schließen Sie sich uns im Kampf gegen Voreingenommenheit an"
  },
  "join.content": {
    "en": "We believe technology can make news consumption better and protect democracy. So, why not give BiasScanner a try? By using it (and maybe even sharing interesting results with us trough the application), you not only help yourself, but you also contribute to ongoing research on bias in news. Let's work together to make online news a more reliable source of information.",
    "de": "Wir glauben, dass Technologie die Nachrichtenkonsum verbessern und die Demokratie schützen kann. Also, warum nicht BiasScanner ausprobieren? Indem Sie es verwenden (und vielleicht sogar interessante Ergebnisse mit uns über die Anwendung teilen), helfen Sie nicht nur sich selbst, sondern tragen auch zur laufenden Forschung über Voreingenommenheit in den Nachrichten bei. Lassen Sie uns zusammenarbeiten, um Online-Nachrichten zu einer zuverlässigeren Informationsquelle zu machen."
  },
  "team.title": {
    "en": "Our Team",
    "de": "Unser Team"
  },
  "team.content": {
    "en": "(Bias Scanner is being developed by the Information Access Research Group (IARG) of the Center for Responsible Artificial Intelligence (CRAI) at Coburg University of Applied Sciences. The group members include: Jochen Leidner, Tim Menzner (mainly responsible for Bias Scanner), Michael Reiche and Markos Dimitsas).",
    "de": "(Bias Scanner wird von der Information Access Research Group (IARG) des Center for Responsible Artificial Intelligence (CRAU) an der Hochschule Coburg entwickelt. Zu den Mitgliedern der Gruppe gehören: Jochen Leidner, Tim Menzner (hauptverantwortlich für Bias Scanner), Michael Reiche und Markos Dimitsas)."
  },
  "download.title": {
    "en": "Download",
    "de": "Download"
  },
  "contact.title": {
    "en": "Contact Us",
    "de": "Kontaktieren Sie uns"
  },
  "contact.content": {
    "en": "If you have any questions or would like to get involved, feel free to contact us at ",
    "de": "Wenn Sie Fragen haben oder sich beteiligen möchten, kontaktieren Sie uns gerne unter "
  },
  "demo.title": {
    "en": "Try out the live demo!",
    "de": "Probieren Sie die Demo aus!"
  },
  "slider.label": {
    "en": "Minimum Strength",
    "de": "Minimale Stärke"
  },
  "button.label": {
    "en": "Detect Bias!",
    "de": "Bias erkennen!"
  },
    "button.report": {
    "en": "Show report",
    "de": "Report anzeigen"
  },
    "button.text": {
    "en": "Show text",
    "de": "Text anzeigen"
  },
    "button.reset": {
    "en": "Change text",
    "de": "Text ändern"
  },
   "error.background": {
    "en": "There was an error with the background script. Maybe try restarting the addon.",
    "de": "Es gab einen Fehler mit dem Background-Skript. Probieren Sie das Add-on neu zu starten."
  },
  "sort.strength": {
    "en": "Sort by bias strength",
    "de": "Nach Bias-Stärke sortieren"
  },
  "sort.occurrence": {
    "en": "Sort by occurrence",
    "de": "Nach Vorkommnis sortieren"
  },
  "overview.percentage": {
    "en": "Percentage of biased sentences",
    "de": "Prozentsatz der tendenziösen Sätze"
  },
  "overview.frequent": {
    "en": "Most frequent bias",
    "de": "Häufigste Tendenz"
  },
  "overview.average": {
    "en": "Average bias strength:",
    "de": "Durchschnittliche Bias-Stärke:"
  },
  "overview.rating": {
    "en": "Overall rating",
    "de": "Gesamtbewertung"
  },




};

var answer_json = null;


// Function to update the content based on the selected language
function updateLanguage(selectedLanguage) {
  document.querySelectorAll('[data-translate]').forEach(element => {
    const translationKey = element.getAttribute('data-translate');
    const translatedContent = translations[translationKey]?.[selectedLanguage];

    if (translatedContent) {
      element.textContent = translatedContent;
    }
  });
}


function switchDemo() {

    if (document.getElementById("demo").style.display == "none")
        {document.querySelectorAll('a').forEach(a => a.addEventListener('click', switchDemo));}
    else
    {
      document.querySelectorAll('a:not([id^="demo-link"])').forEach(a => a.removeEventListener('click', switchDemo));
    }


    document.querySelectorAll('section').forEach(element => {

       console.log(element, element.style.display);

        if (element.style.display != "none")
        {
           element.style.display = "none";
        }
        else
        {
           element.style.display = "";
        }
    });
}

function constructMessage()
{
    message = {
  "type": "prompt",
  "text": document.getElementById("demo-text").value,
  "url": "www.biasscanner.org",
  "language": document.getElementById("language-select").value
   };


  return message;

}


function changeText()
{
   document.getElementById("sent-text").style.display = "none";
   document.getElementById("bias-report").style.display = "none";
   document.getElementById("demo-text").style.display = "";

    document.getElementById("show-report").style.backgroundColor = "#A9A9A9";
    document.getElementById("show-report").disabled = true;

    document.getElementById("reset-text").style.backgroundColor = "#A9A9A9";
    document.getElementById("reset-text").disabled = true;

    document.getElementById("detect-bias").style.backgroundColor = "#4caf50";
    document.getElementById("detect-bias").disabled = false;

}

/* ###############
    PART FROM ADDON
################## */

/*!***************************************************
* mark.js v9.0.0
* https://markjs.io/
* Copyright (c) 2014–2018, Julian Kühnel
* Released under the MIT license https://git.io/vwTVl
*****************************************************/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Mark=t()}(this,function(){"use strict";function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function r(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}var i=
/* */
function(){function e(n){var r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:5e3;t(this,e),this.ctx=n,this.iframes=r,this.exclude=o,this.iframesTimeout=i}return r(e,[{key:"getContexts",value:function(){var e=[];return(void 0!==this.ctx&&this.ctx?NodeList.prototype.isPrototypeOf(this.ctx)?Array.prototype.slice.call(this.ctx):Array.isArray(this.ctx)?this.ctx:"string"==typeof this.ctx?Array.prototype.slice.call(document.querySelectorAll(this.ctx)):[this.ctx]:[]).forEach(function(t){var n=e.filter(function(e){return e.contains(t)}).length>0;-1!==e.indexOf(t)||n||e.push(t)}),e}},{key:"getIframeContents",value:function(e,t){var n,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){};try{var o=e.contentWindow;if(n=o.document,!o||!n)throw new Error("iframe inaccessible")}catch(e){r()}n&&t(n)}},{key:"isIframeBlank",value:function(e){var t="about:blank",n=e.getAttribute("src").trim();return e.contentWindow.location.href===t&&n!==t&&n}},{key:"observeIframeLoad",value:function(e,t,n){var r=this,o=!1,i=null,a=function a(){if(!o){o=!0,clearTimeout(i);try{r.isIframeBlank(e)||(e.removeEventListener("load",a),r.getIframeContents(e,t,n))}catch(e){n()}}};e.addEventListener("load",a),i=setTimeout(a,this.iframesTimeout)}},{key:"onIframeReady",value:function(e,t,n){try{"complete"===e.contentWindow.document.readyState?this.isIframeBlank(e)?this.observeIframeLoad(e,t,n):this.getIframeContents(e,t,n):this.observeIframeLoad(e,t,n)}catch(e){n()}}},{key:"waitForIframes",value:function(e,t){var n=this,r=0;this.forEachIframe(e,function(){return!0},function(e){r++,n.waitForIframes(e.querySelector("html"),function(){--r||t()})},function(e){e||t()})}},{key:"forEachIframe",value:function(t,n,r){var o=this,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(){},a=t.querySelectorAll("iframe"),s=a.length,c=0;a=Array.prototype.slice.call(a);var u=function(){--s<=0&&i(c)};s||u(),a.forEach(function(t){e.matches(t,o.exclude)?u():o.onIframeReady(t,function(e){n(t)&&(c++,r(e)),u()},u)})}},{key:"createIterator",value:function(e,t,n){return document.createNodeIterator(e,t,n,!1)}},{key:"createInstanceOnIframe",value:function(t){return new e(t.querySelector("html"),this.iframes)}},{key:"compareNodeIframe",value:function(e,t,n){if(e.compareDocumentPosition(n)&Node.DOCUMENT_POSITION_PRECEDING){if(null===t)return!0;if(t.compareDocumentPosition(n)&Node.DOCUMENT_POSITION_FOLLOWING)return!0}return!1}},{key:"getIteratorNode",value:function(e){var t=e.previousNode();return{prevNode:t,node:null===t?e.nextNode():e.nextNode()&&e.nextNode()}}},{key:"checkIframeFilter",value:function(e,t,n,r){var o=!1,i=!1;return r.forEach(function(e,t){e.val===n&&(o=t,i=e.handled)}),this.compareNodeIframe(e,t,n)?(!1!==o||i?!1===o||i||(r[o].handled=!0):r.push({val:n,handled:!0}),!0):(!1===o&&r.push({val:n,handled:!1}),!1)}},{key:"handleOpenIframes",value:function(e,t,n,r){var o=this;e.forEach(function(e){e.handled||o.getIframeContents(e.val,function(e){o.createInstanceOnIframe(e).forEachNode(t,n,r)})})}},{key:"iterateThroughNodes",value:function(e,t,n,r,o){for(var i,a,s,c=this,u=this.createIterator(t,e,r),l=[],h=[];s=void 0,s=c.getIteratorNode(u),a=s.prevNode,i=s.node;)this.iframes&&this.forEachIframe(t,function(e){return c.checkIframeFilter(i,a,e,l)},function(t){c.createInstanceOnIframe(t).forEachNode(e,function(e){return h.push(e)},r)}),h.push(i);h.forEach(function(e){n(e)}),this.iframes&&this.handleOpenIframes(l,e,n,r),o()}},{key:"forEachNode",value:function(e,t,n){var r=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(){},i=this.getContexts(),a=i.length;a||o(),i.forEach(function(i){var s=function(){r.iterateThroughNodes(e,i,t,n,function(){--a<=0&&o()})};r.iframes?r.waitForIframes(i,s):s()})}}],[{key:"matches",value:function(e,t){var n="string"==typeof t?[t]:t,r=e.matches||e.matchesSelector||e.msMatchesSelector||e.mozMatchesSelector||e.oMatchesSelector||e.webkitMatchesSelector;if(r){var o=!1;return n.every(function(t){return!r.call(e,t)||(o=!0,!1)}),o}return!1}}]),e}(),a=
/* */
function(){function e(n){t(this,e),this.opt=o({},{diacritics:!0,synonyms:{},accuracy:"partially",caseSensitive:!1,ignoreJoiners:!1,ignorePunctuation:[],wildcards:"disabled"},n)}return r(e,[{key:"create",value:function(e){return"disabled"!==this.opt.wildcards&&(e=this.setupWildcardsRegExp(e)),e=this.escapeStr(e),Object.keys(this.opt.synonyms).length&&(e=this.createSynonymsRegExp(e)),(this.opt.ignoreJoiners||this.opt.ignorePunctuation.length)&&(e=this.setupIgnoreJoinersRegExp(e)),this.opt.diacritics&&(e=this.createDiacriticsRegExp(e)),e=this.createMergedBlanksRegExp(e),(this.opt.ignoreJoiners||this.opt.ignorePunctuation.length)&&(e=this.createJoinersRegExp(e)),"disabled"!==this.opt.wildcards&&(e=this.createWildcardsRegExp(e)),e=this.createAccuracyRegExp(e),new RegExp(e,"gm".concat(this.opt.caseSensitive?"":"i"))}},{key:"sortByLength",value:function(e){return e.sort(function(e,t){return e.length===t.length?e>t?1:-1:t.length-e.length})}},{key:"escapeStr",value:function(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}},{key:"createSynonymsRegExp",value:function(e){var t=this,n=this.opt.synonyms,r=this.opt.caseSensitive?"":"i",o=this.opt.ignoreJoiners||this.opt.ignorePunctuation.length?"\0":"";for(var i in n)if(n.hasOwnProperty(i)){var a=Array.isArray(n[i])?n[i]:[n[i]];a.unshift(i),(a=this.sortByLength(a).map(function(e){return"disabled"!==t.opt.wildcards&&(e=t.setupWildcardsRegExp(e)),e=t.escapeStr(e)}).filter(function(e){return""!==e})).length>1&&(e=e.replace(new RegExp("(".concat(a.map(function(e){return t.escapeStr(e)}).join("|"),")"),"gm".concat(r)),o+"(".concat(a.map(function(e){return t.processSynonyms(e)}).join("|"),")")+o))}return e}},{key:"processSynonyms",value:function(e){return(this.opt.ignoreJoiners||this.opt.ignorePunctuation.length)&&(e=this.setupIgnoreJoinersRegExp(e)),e}},{key:"setupWildcardsRegExp",value:function(e){return(e=e.replace(/(?:\\)*\?/g,function(e){return"\\"===e.charAt(0)?"?":""})).replace(/(?:\\)*\*/g,function(e){return"\\"===e.charAt(0)?"*":""})}},{key:"createWildcardsRegExp",value:function(e){var t="withSpaces"===this.opt.wildcards;return e.replace(/\u0001/g,t?"[\\S\\s]?":"\\S?").replace(/\u0002/g,t?"[\\S\\s]*?":"\\S*")}},{key:"setupIgnoreJoinersRegExp",value:function(e){return e.replace(/[^(|)\\]/g,function(e,t,n){var r=n.charAt(t+1);return/[(|)\\]/.test(r)||""===r?e:e+"\0"})}},{key:"createJoinersRegExp",value:function(e){var t=[],n=this.opt.ignorePunctuation;return Array.isArray(n)&&n.length&&t.push(this.escapeStr(n.join(""))),this.opt.ignoreJoiners&&t.push("\\u00ad\\u200b\\u200c\\u200d"),t.length?e.split(/\u0000+/).join("[".concat(t.join(""),"]*")):e}},{key:"createDiacriticsRegExp",value:function(e){var t=this.opt.caseSensitive?"":"i",n=this.opt.caseSensitive?["aàáảãạăằắẳẵặâầấẩẫậäåāą","AÀÁẢÃẠĂẰẮẲẴẶÂẦẤẨẪẬÄÅĀĄ","cçćč","CÇĆČ","dđď","DĐĎ","eèéẻẽẹêềếểễệëěēę","EÈÉẺẼẸÊỀẾỂỄỆËĚĒĘ","iìíỉĩịîïī","IÌÍỈĨỊÎÏĪ","lł","LŁ","nñňń","NÑŇŃ","oòóỏõọôồốổỗộơởỡớờợöøō","OÒÓỎÕỌÔỒỐỔỖỘƠỞỠỚỜỢÖØŌ","rř","RŘ","sšśșş","SŠŚȘŞ","tťțţ","TŤȚŢ","uùúủũụưừứửữựûüůū","UÙÚỦŨỤƯỪỨỬỮỰÛÜŮŪ","yýỳỷỹỵÿ","YÝỲỶỸỴŸ","zžżź","ZŽŻŹ"]:["aàáảãạăằắẳẵặâầấẩẫậäåāąAÀÁẢÃẠĂẰẮẲẴẶÂẦẤẨẪẬÄÅĀĄ","cçćčCÇĆČ","dđďDĐĎ","eèéẻẽẹêềếểễệëěēęEÈÉẺẼẸÊỀẾỂỄỆËĚĒĘ","iìíỉĩịîïīIÌÍỈĨỊÎÏĪ","lłLŁ","nñňńNÑŇŃ","oòóỏõọôồốổỗộơởỡớờợöøōOÒÓỎÕỌÔỒỐỔỖỘƠỞỠỚỜỢÖØŌ","rřRŘ","sšśșşSŠŚȘŞ","tťțţTŤȚŢ","uùúủũụưừứửữựûüůūUÙÚỦŨỤƯỪỨỬỮỰÛÜŮŪ","yýỳỷỹỵÿYÝỲỶỸỴŸ","zžżźZŽŻŹ"],r=[];return e.split("").forEach(function(o){n.every(function(n){if(-1!==n.indexOf(o)){if(r.indexOf(n)>-1)return!1;e=e.replace(new RegExp("[".concat(n,"]"),"gm".concat(t)),"[".concat(n,"]")),r.push(n)}return!0})}),e}},{key:"createMergedBlanksRegExp",value:function(e){return e.replace(/[\s]+/gim,"[\\s]+")}},{key:"createAccuracyRegExp",value:function(e){var t=this,n=this.opt.accuracy,r="string"==typeof n?n:n.value,o="string"==typeof n?[]:n.limiters,i="";switch(o.forEach(function(e){i+="|".concat(t.escapeStr(e))}),r){case"partially":default:return"()(".concat(e,")");case"complementary":return i="\\s"+(i||this.escapeStr("!\"#$%&'()*+,-./:;<=>?@[\\]^_`{|}~¡¿")),"()([^".concat(i,"]*").concat(e,"[^").concat(i,"]*)");case"exactly":return"(^|\\s".concat(i,")(").concat(e,")(?=$|\\s").concat(i,")")}}}]),e}(),s=
/* */
function(){function n(e){t(this,n),this.ctx=e,this.ie=!1;var r=window.navigator.userAgent;(r.indexOf("MSIE")>-1||r.indexOf("Trident")>-1)&&(this.ie=!0)}return r(n,[{key:"log",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"debug",r=this.opt.log;this.opt.debug&&"object"===e(r)&&"function"==typeof r[n]&&r[n]("mark.js: ".concat(t))}},{key:"getSeparatedKeywords",value:function(e){var t=this,n=[];return e.forEach(function(e){t.opt.separateWordSearch?e.split(" ").forEach(function(e){e.trim()&&-1===n.indexOf(e)&&n.push(e)}):e.trim()&&-1===n.indexOf(e)&&n.push(e)}),{keywords:n.sort(function(e,t){return t.length-e.length}),length:n.length}}},{key:"isNumeric",value:function(e){return Number(parseFloat(e))==e}},{key:"checkRanges",value:function(e){var t=this;if(!Array.isArray(e)||"[object Object]"!==Object.prototype.toString.call(e[0]))return this.log("markRanges() will only accept an array of objects"),this.opt.noMatch(e),[];var n=[],r=0;return e.sort(function(e,t){return e.start-t.start}).forEach(function(e){var o=t.callNoMatchOnInvalidRanges(e,r),i=o.start,a=o.end;o.valid&&(e.start=i,e.length=a-i,n.push(e),r=a)}),n}},{key:"callNoMatchOnInvalidRanges",value:function(e,t){var n,r,o=!1;return e&&void 0!==e.start?(r=(n=parseInt(e.start,10))+parseInt(e.length,10),this.isNumeric(e.start)&&this.isNumeric(e.length)&&r-t>0&&r-n>0?o=!0:(this.log("Ignoring invalid or overlapping range: "+"".concat(JSON.stringify(e))),this.opt.noMatch(e))):(this.log("Ignoring invalid range: ".concat(JSON.stringify(e))),this.opt.noMatch(e)),{start:n,end:r,valid:o}}},{key:"checkWhitespaceRanges",value:function(e,t,n){var r,o=!0,i=n.length,a=t-i,s=parseInt(e.start,10)-a;return(r=(s=s>i?i:s)+parseInt(e.length,10))>i&&(r=i,this.log("End range automatically set to the max value of ".concat(i))),s<0||r-s<0||s>i||r>i?(o=!1,this.log("Invalid range: ".concat(JSON.stringify(e))),this.opt.noMatch(e)):""===n.substring(s,r).replace(/\s+/g,"")&&(o=!1,this.log("Skipping whitespace only range: "+JSON.stringify(e)),this.opt.noMatch(e)),{start:s,end:r,valid:o}}},{key:"getTextNodes",value:function(e){var t=this,n="",r=[];this.iterator.forEachNode(NodeFilter.SHOW_TEXT,function(e){r.push({start:n.length,end:(n+=e.textContent).length,node:e})},function(e){return t.matchesExclude(e.parentNode)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT},function(){e({value:n,nodes:r})})}},{key:"matchesExclude",value:function(e){return i.matches(e,this.opt.exclude.concat(["script","style","title","head","html"]))}},{key:"wrapRangeInTextNode",value:function(e,t,n){var r=this.opt.element?this.opt.element:"mark",o=e.splitText(t),i=o.splitText(n-t),a=document.createElement(r);return a.setAttribute("data-markjs","true"),this.opt.className&&a.setAttribute("class",this.opt.className),a.textContent=o.textContent,o.parentNode.replaceChild(a,o),i}},{key:"wrapRangeInMappedTextNode",value:function(e,t,n,r,o){var i=this;e.nodes.every(function(a,s){var c=e.nodes[s+1];if(void 0===c||c.start>t){if(!r(a.node))return!1;var u=t-a.start,l=(n>a.end?a.end:n)-a.start,h=e.value.substr(0,a.start),f=e.value.substr(l+a.start);if(a.node=i.wrapRangeInTextNode(a.node,u,l),e.value=h+f,e.nodes.forEach(function(t,n){n>=s&&(e.nodes[n].start>0&&n!==s&&(e.nodes[n].start-=l),e.nodes[n].end-=l)}),n-=l,o(a.node.previousSibling,a.start),!(n>a.end))return!1;t=a.end}return!0})}},{key:"wrapGroups",value:function(e,t,n,r){return r((e=this.wrapRangeInTextNode(e,t,t+n)).previousSibling),e}},{key:"separateGroups",value:function(e,t,n,r,o){for(var i=t.length,a=1;a<i;a++){var s=e.textContent.indexOf(t[a]);t[a]&&s>-1&&r(t[a],e)&&(e=this.wrapGroups(e,s,t[a].length,o))}return e}},{key:"wrapMatches",value:function(e,t,n,r,o){var i=this,a=0===t?0:t+1;this.getTextNodes(function(t){t.nodes.forEach(function(t){var o;for(t=t.node;null!==(o=e.exec(t.textContent))&&""!==o[a];){if(i.opt.separateGroups)t=i.separateGroups(t,o,a,n,r);else{if(!n(o[a],t))continue;var s=o.index;if(0!==a)for(var c=1;c<a;c++)s+=o[c].length;t=i.wrapGroups(t,s,o[a].length,r)}e.lastIndex=0}}),o()})}},{key:"wrapMatchesAcrossElements",value:function(e,t,n,r,o){var i=this,a=0===t?0:t+1;this.getTextNodes(function(t){for(var s;null!==(s=e.exec(t.value))&&""!==s[a];){var c=s.index;if(0!==a)for(var u=1;u<a;u++)c+=s[u].length;var l=c+s[a].length;i.wrapRangeInMappedTextNode(t,c,l,function(e){return n(s[a],e)},function(t,n){e.lastIndex=n,r(t)})}o()})}},{key:"wrapRangeFromIndex",value:function(e,t,n,r){var o=this;this.getTextNodes(function(i){var a=i.value.length;e.forEach(function(e,r){var s=o.checkWhitespaceRanges(e,a,i.value),c=s.start,u=s.end;s.valid&&o.wrapRangeInMappedTextNode(i,c,u,function(n){return t(n,e,i.value.substring(c,u),r)},function(t){n(t,e)})}),r()})}},{key:"unwrapMatches",value:function(e){for(var t=e.parentNode,n=document.createDocumentFragment();e.firstChild;)n.appendChild(e.removeChild(e.firstChild));t.replaceChild(n,e),this.ie?this.normalizeTextNode(t):t.normalize()}},{key:"normalizeTextNode",value:function(e){if(e){if(3===e.nodeType)for(;e.nextSibling&&3===e.nextSibling.nodeType;)e.nodeValue+=e.nextSibling.nodeValue,e.parentNode.removeChild(e.nextSibling);else this.normalizeTextNode(e.firstChild);this.normalizeTextNode(e.nextSibling)}}},{key:"markRegExp",value:function(e,t){var n=this;this.opt=t,this.log('Searching with expression "'.concat(e,'"'));var r=0,o="wrapMatches";this.opt.acrossElements&&(o="wrapMatchesAcrossElements"),this[o](e,this.opt.ignoreGroups,function(e,t){return n.opt.filter(t,e,r)},function(e){r++,n.opt.each(e)},function(){0===r&&n.opt.noMatch(e),n.opt.done(r)})}},{key:"mark",value:function(e,t){var n=this;this.opt=t;var r=0,o="wrapMatches",i=this.getSeparatedKeywords("string"==typeof e?[e]:e),s=i.keywords,c=i.length;this.opt.acrossElements&&(o="wrapMatchesAcrossElements"),0===c?this.opt.done(r):function e(t){var i=new a(n.opt).create(t),u=0;n.log('Searching with expression "'.concat(i,'"')),n[o](i,1,function(e,o){return n.opt.filter(o,t,r,u)},function(e){u++,r++,n.opt.each(e)},function(){0===u&&n.opt.noMatch(t),s[c-1]===t?n.opt.done(r):e(s[s.indexOf(t)+1])})}(s[0])}},{key:"markRanges",value:function(e,t){var n=this;this.opt=t;var r=0,o=this.checkRanges(e);o&&o.length?(this.log("Starting to mark with the following ranges: "+JSON.stringify(o)),this.wrapRangeFromIndex(o,function(e,t,r,o){return n.opt.filter(e,t,r,o)},function(e,t){r++,n.opt.each(e,t)},function(){n.opt.done(r)})):this.opt.done(r)}},{key:"unmark",value:function(e){var t=this;this.opt=e;var n=this.opt.element?this.opt.element:"*";n+="[data-markjs]",this.opt.className&&(n+=".".concat(this.opt.className)),this.log('Removal selector "'.concat(n,'"')),this.iterator.forEachNode(NodeFilter.SHOW_ELEMENT,function(e){t.unwrapMatches(e)},function(e){var r=i.matches(e,n),o=t.matchesExclude(e);return!r||o?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT},this.opt.done)}},{key:"opt",set:function(e){this._opt=o({},{element:"",className:"",exclude:[],iframes:!1,iframesTimeout:5e3,separateWordSearch:!0,acrossElements:!1,ignoreGroups:0,each:function(){},noMatch:function(){},filter:function(){return!0},done:function(){},debug:!1,log:window.console},e)},get:function(){return this._opt}},{key:"iterator",get:function(){return new i(this.ctx,this.opt.iframes,this.opt.exclude,this.opt.iframesTimeout)}}]),n}();return function(e){var t=this,n=new s(e);return this.mark=function(e,r){return n.mark(e,r),t},this.markRegExp=function(e,r){return n.markRegExp(e,r),t},this.markRanges=function(e,r){return n.markRanges(e,r),t},this.unmark=function(e){return n.unmark(e),t},this}});
/*****************************************************/


function filterData(data) {

  article = document.getElementById("sent-text").innerHTML;

  data = fixJson(data);

  filtered_sentences = [];
  for (sentence of data.sentences) {
    if (!isSubstringWithTolerance(article, sentence.text, 0.2) || checkNegation(sentence)) {
      console.log("Removing because of filter: ", sentence);
      console.log ("Substring: ", isSubstringWithTolerance(article,sentence.text, 0.2));
      console.log("Negation: ", checkNegation(sentence));
    } else {
      filtered_sentences.push(sentence);
    }
  }
  data.sentences = filtered_sentences;
  return data;
}

function isSubstringWithTolerance(targetString, substring, tolerance) {

  targetString = targetString.replace(/\s/g, '');
  substring = substring.replace(/\s/g, '');

  // Calculate the maximum allowed difference based on the length of the substring
  const maxDifference = Math.floor(substring.length * tolerance);


  // Iterate through the targetString to find matching substrings
  for (let i = 0; i <= targetString.length - substring.length; i++) {
    let difference = 0;

    // Compare each character of the substring with the corresponding character in targetString
    for (let j = 0; j < substring.length; j++) {
      if (targetString[i + j] !== substring[j]) {
        difference++;
      }

      // If the difference exceeds the threshold, move to the next starting position in targetString
      if (difference > maxDifference) {
        break;
      }
    }

    // If the difference is within the tolerance, return true
    if (difference <= maxDifference) {
      console.log(difference, maxDifference);
      return true;
    }
  }

  // If no matching substring is found, return false
  return false;
}

function checkNegation(sentence) {
    let bias_type = "";
    let bias_strength = 0;
    let bias_description = "";

    if ("bias_type" in sentence) {
        bias_type = sentence.bias_type;
    }
    if ("bias_strength" in sentence) {
        bias_strength = sentence.bias_strength;
    }
    if ("bias_description" in sentence) {
        bias_description = sentence.bias_description;
    }

    if (
        bias_type === "" || bias_type === "-" || bias_type === "None" || bias_type === null
        || (bias_type.toLowerCase().includes("no ") && language == "en")
        || (bias_type.toLowerCase().includes("kein ") && language == "de")
        || bias_strength === 0
        || bias_description === "" || bias_description === "-" || bias_description === null
        || (bias_description.toLowerCase().includes("any bias") && language == "en")
        || (bias_description.toLowerCase().includes("no bias") && language == "en")
        || (bias_description.toLowerCase().includes("kein bias") && language == "de")
    ) {
        return true;
    }

    return false;
}


function fixJson(json) {

  if (!json.hasOwnProperty('sentences')) {
    json.sentences = [];
  }

  // Check if the JSON has the incorrect key
  if (json.hasOwnProperty('overall bias')) {
    // Replace the incorrect key with the correct one
    json['overall_bias'] = json['overall bias'];
    delete json['overall bias'];
  }

      if (!json.hasOwnProperty('overall_bias') && json.hasOwnProperty("conclusion")) {
    json.overall_bias = json.conclusion;
  }

  console.log("JSON", json);
  return json;
}


function findJSON(text)
{
  const jsonRegex = /{(?:[^{}]|{(?:[^{}]|{[^{}]*})*})*}/;
  const match = text.match(jsonRegex);

  if (match) {
  return JSON.parse(match[0]);
  }
  return false;
}

function filterStrength(data,threshold)
{

  data = structuredClone(data);
  data.sentences = data.sentences.filter(sentence => sentence.bias_strength >= threshold);
  return data

}

function addHover() {
  markElements = document.querySelectorAll('mark');

  markElements.forEach((markElement) => {
    const matchedSentence = answer_json.sentences.find(s => isSubstringWithTolerance(s.text, markElement.innerText, 0.1));
    const biasType = matchedSentence?.bias_type || "Bias type not found";
    const biasStrength = matchedSentence?.bias_strength || "Bias strength not found";
    const biasDescription = matchedSentence?.bias_description || "Bias description not found";
    markElement.setAttribute('title', `${biasType} (${biasStrength}) - ${biasDescription}`);
  });
}

function sortAndFormat(data,sort)
{

language = document.getElementById("language-select").value;

console.log(document.getElementById("reset-text").innerText, translations["sort.occurrence"][language])

data = structuredClone(data);

if (!data.sentences || data.sentences.length == 0)
{
  return data.overall_bias.conclusion;
}


if (sort)
{data.sentences.sort((a, b) => b.bias_strength - a.bias_strength);}

console.log(data);

var output = "\n"
var sentenceNumber = 1;

for (sentence of data.sentences)
    {
        output += `<b>${sentenceNumber}. ${sentence.text}</b> (${sentence.bias_type}: ${sentence.bias_strength})\n- ${sentence.bias_description}\n\n`;
        sentenceNumber++;
    }

output = output + data.overall_bias.conclusion;

stats = getStatistics(data,article);

if (stats)
{

rating = (stats[2] / 100 + stats[4]) / 2;

output += `\n\n${translations["overview.percentage"][language]}: ${stats[2]}

${translations["overview.frequent"][language]}: ${stats[3][0][0]} (${stats[3][0][1]} ${translations["overview.frequent"][language]})
${translations["overview.average"][language]}: ${stats[4]}
${translations["overview.rating"][language]}: ${rating}`;

}

return output;

}

function getStatistics(data,article)
 {

   article_sentences = article.split(/[.?!]/g).filter(Boolean).length;

    marked_sentences = data.sentences.length;

    if (marked_sentences == 0)
        return false;

    ratio = marked_sentences / article_sentences; //marked sentences != named sentences as conclusion might be in ranking (fix)

    const biasScores = data.sentences.map(sentence => sentence.bias_strength);
    const sum_score = biasScores.reduce((sum, score) => sum + score, 0);
    const average_score = sum_score / biasScores.length;

    let type_frequencies = {};

    for (sentence of data.sentences)
    {
       console.log(type_frequencies[sentence.bias_type]);
       type_frequencies[sentence.bias_type] = (type_frequencies[sentence.bias_type] || 0) + 1;
    }

    const keyValuePairs = Object.entries(type_frequencies);

    // Sort the array of key-value pairs based on the values in descending order
    keyValuePairs.sort((a, b) => b[1] - a[1]);

    return [article_sentences,marked_sentences,parseFloat(ratio.toFixed(2))*100,keyValuePairs,parseFloat(average_score.toFixed(2))];

 }




function tryMarking(instance, sentence, step) {

console.log(sentence);

  if (step == 1) {
    sentence = sentence.split(" ...")[0];
  }
  if (step ==2)
  {
  const pattern = new RegExp(`[${["'", '"', '.', ';', ',', '!', '?'].join('')}]`, 'g');
  sentence = sentence.replace(pattern, '');
  }
  else if (step > 2)
  {
     return null;
  }

  instance.mark(sentence, {accuracy: "partially",ignorePunctuation: ["'","\"",".",";",",","!","?"],separateWordSearch: false,acrossElements: true,noMatch: tryMarking(instance, sentence, ++step),debug: false
  });
}

function markSentences(data) {

  instance = new Mark(document);


  for (sentence of data.sentences) {
    try {
      tryMarking(instance, sentence.text,0);
    } catch (err) {
      console.log(err, sentence);
    }
  }

  addHover();
}

function showReport() {

    language = document.getElementById("language-select").value

    if (document.getElementById("sent-text").style.display == "")
    {
        document.getElementById("sent-text").style.display = "none";
        document.getElementById("bias-report").style.display = "";
        document.getElementById("show-report").innerText = translations["button.text"][language];

       document.getElementById("reset-text").innerText = translations["sort.strength"][language]
       document.getElementById("reset-text").removeEventListener('click', changeText);
       document.getElementById("reset-text").addEventListener('click', sensitivityMoved);

        //document.getElementById("reset-text").style.backgroundColor = "#A9A9A9";
        //document.getElementById("reset-text").disabled = true;

    }
    else
    {
        document.getElementById("sent-text").style.display = "";
        document.getElementById("bias-report").style.display = "none";
        document.getElementById("show-report").innerText = translations["button.report"][language];

       document.getElementById("reset-text").innerText = translations["button.reset"][language]

       document.getElementById("reset-text").removeEventListener('click', sensitivityMoved);
       document.getElementById("reset-text").addEventListener('click', changeText);

       //document.getElementById("reset-text").style.backgroundColor = "#4caf50";
       //document.getElementById("reset-text").disabled = false;
    }


}

function sensitivityMoved(event)
{
  document.getElementById('slider-value').textContent = document.getElementById("sensitivity-slider").value;
  document.getElementById('slider-value').style.right = 61.111 - document.getElementById("sensitivity-slider").value * 111.111 + "%"
  console.log(document.getElementById('slider-value').style.right);

  if (answer_json)
  {
  visible_answer = filterStrength(answer_json,document.getElementById("slider-value").innerText)
  if (event.type == "input")
  {
  instance = new Mark(document);
  instance.unmark();
  markSentences(visible_answer);

  if (document.getElementById("reset-text").innerText == translations["sort.occurrence"][language])
    {
        sort = true;
    }
     else if (document.getElementById("reset-text").innerText == translations["sort.strength"][language])
    {
      sort = false;

  }
  }
  else if (event.type == "click")
  {
       if (document.getElementById("reset-text").innerText == translations["sort.strength"][language])
    {
        sort = true;

       document.getElementById("reset-text").innerText = translations["sort.occurrence"][language];

    }

     else if (document.getElementById("reset-text").innerText == translations["sort.occurrence"][language])
    {
      sort = false;

      document.getElementById("reset-text").innerText = translations["sort.strength"][language];
      }
    }
  }

  summarization = sortAndFormat(visible_answer, sort);
  document.getElementById("bias-report").innerHTML = summarization;

  }



function sendRequest()
{

message = constructMessage();

document.getElementById("sent-text").innerHTML = message.text;
document.getElementById("sent-text").style.display = "";

document.getElementById("demo-text").style.display = "none";

fetch('https://app.biasscanner.org:8080', {
    method: 'POST',
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      "type": message.type,
      "text": message.text,
      "url": message.url,
      "language": message.language
    })
  })
  .then((response) => response.text())
  .then((answer) => {
    try {
        answer_json = JSON.parse(answer);
      } catch (error) {
        console.log("Could not parse JSON, searching in message.")
        answer_json = findJSON(answer);
        console.log("Found JSON: ", answer_json)
      }

      if (!answer_json) {
        x = translations["error.background"][language];
        answer_json = JSON.parse('{"sentences":[],"overall bias":{"conclusion": x}}');
      }
      answer_json = filterData(answer_json);
      visible_answer = filterStrength(answer_json,document.getElementById("slider-value").innerText)
      markSentences(visible_answer);
      summarization = sortAndFormat(visible_answer, false)

      document.getElementById("detect-bias").style.backgroundColor = "#A9A9A9";
      document.getElementById("detect-bias").disabled = true;
      document.getElementById("show-report").style.backgroundColor = "#4caf50";
      document.getElementById("show-report").disabled = false;
      document.getElementById("reset-text").style.backgroundColor = "#4caf50";
      document.getElementById("reset-text").disabled = false;
      document.getElementById("bias-report").innerHTML = summarization;
    return true;
  })
  .catch((error) => {
    // Handle errors here if needed.
    console.error(error);
    return true;
  });
}




/* ###############
    PART FROM ADDON
##################
*/



document.addEventListener('DOMContentLoaded', () => {

 document.getElementById("sensitivity-slider").addEventListener('input', sensitivityMoved);

  document.getElementById("demo-link").addEventListener('click', switchDemo);
  document.getElementById("demo-link-2").addEventListener('click', switchDemo);

  document.getElementById("detect-bias").addEventListener('click',sendRequest);

  document.getElementById("show-report").addEventListener('click', showReport);

  document.getElementById("reset-text").addEventListener('click', changeText);

  document.getElementById('slider-value').textContent = document.getElementById("sensitivity-slider").value

  const languageSelect = document.getElementById("language");

  // Initial update of content based on the default language
  const defaultLanguage = languageSelect.value; // Assuming 'en' is the default language
  updateLanguage(defaultLanguage);

  // Add an event listener for the 'change' event
  languageSelect.addEventListener('change', () => {
    // Get the selected value
    const selectedLanguage = languageSelect.value;

    // Update the content based on the selected language
    updateLanguage(selectedLanguage);

    // You can perform additional actions based on the selected language here
    console.log('Selected language:', selectedLanguage);
    // For example, you can redirect to a page based on the selected language
    // window.location.href = `/${selectedLanguage}/index.html`;
  });
});





